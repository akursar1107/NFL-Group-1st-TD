<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Picks - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .pending-row { background-color: #fff3cd !important; }
        .win-row { background-color: #d4edda !important; }
        .loss-row { background-color: #f8d7da !important; }
        .btn-xs {
            padding: 0.125rem 0.25rem;
            font-size: 0.75rem;
        }
        .badge-sm {
            font-size: 0.7rem;
            padding: 0.2em 0.4em;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        th.sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 0.8em;
        }
        th.sortable.asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }
        th.sortable.desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand mb-0 h1" href="/">üèà NFL First TD League</a>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-sm btn-outline-light">Standings</a>
                
                <!-- Admin Menu -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                        üîß Admin
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Grading</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('gradeCurrentWeekForm').submit(); return false;">Grade Current Week</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Picks Management</h6></li>
                        <li><a class="dropdown-item" href="/admin/picks/new">‚ûï New Pick</a></li>
                        <li><a class="dropdown-item active" href="/admin/all-picks">üìã All Picks</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Data Quality</h6></li>
                        <li><a class="dropdown-item" href="/admin/match-review">üîç Match Review</a></li>
                    </ul>
                </div>
                
                <!-- Season Selector -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown">
                        {{ season }} Season
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% for s in available_seasons %}
                        <li><a class="dropdown-item {% if s == season %}active{% endif %}" href="/admin/all-picks/{{ s }}">{{ s }} Season</a></li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- User Menu -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                        üë§ {{ current_user.display_name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/change-password">üîë Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">üö™ Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Hidden form for grade current week -->
    <form id="gradeCurrentWeekForm" method="POST" action="/admin/grade-current-week" style="display: none;">
        <input type="hidden" name="season" value="{{ season }}">
    </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="mb-0">üõ°Ô∏è All Picks - {{ season }} Season</h2>
                <small class="text-muted">Total: <span id="totalCount">{{ picks|length }}</span> picks | Showing: <span id="visibleCount">{{ picks|length }}</span></small>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="row g-2 mb-3">
            <div class="col-md-2">
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="üîç Search player, user...">
            </div>
            <div class="col-md-1">
                <select class="form-select form-select-sm" id="weekFilter">
                    <option value="">All Weeks</option>
                    {% for w in range(1, 19) %}
                    <option value="{{ w }}">Week {{ w }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm" id="userFilter">
                    <option value="">All Users</option>
                    {% set users = picks|map(attribute='user')|unique|sort(attribute='username') %}
                    {% for user in users %}
                    <option value="{{ user.username }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <select class="form-select form-select-sm" id="typeFilter">
                    <option value="">All Types</option>
                    <option value="FTD">FTD</option>
                    <option value="ATTS">ATTS</option>
                </select>
            </div>
            <div class="col-md-1">
                <select class="form-select form-select-sm" id="resultFilter">
                    <option value="">All Results</option>
                    <option value="Pending">Pending</option>
                    <option value="W">Win</option>
                    <option value="L">Loss</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm" id="gameFilter">
                    <option value="">All Games</option>
                    {% set games = picks|map(attribute='game')|unique|sort(attribute='game_date', reverse=True) %}
                    {% for game in games %}
                    <option value="{{ game.away_team }} @ {{ game.home_team }}">W{{ game.week }}: {{ game.away_team }} @ {{ game.home_team }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 text-end">
                <form method="POST" action="/admin/grade-all" style="display: inline;">
                    <input type="hidden" name="season" value="{{ season }}">
                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Grade ALL weeks for {{ season }} season? This will process all pending picks across the entire season using fuzzy matching.');">
                        <i class="bi bi-check-all"></i> Grade All
                    </button>
                </form>
                <button class="btn btn-sm btn-warning" onclick="standardizeData()">
                    <i class="bi bi-magic"></i> Standardize Data
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>

        <!-- Picks Table -->
        {% if picks %}
        <div class="table-responsive">
            <table class="table table-sm table-hover" id="picksTable">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-sort="week">Week</th>
                        <th class="sortable" data-sort="game">Game</th>
                        <th class="sortable" data-sort="date">Date</th>
                        <th class="sortable" data-sort="user">User</th>
                        <th class="sortable" data-sort="player">Player</th>
                        <th class="sortable" data-sort="position">Pos</th>
                        <th class="sortable" data-sort="type">Type</th>
                        <th class="sortable" data-sort="odds">Odds</th>
                        <th class="sortable" data-sort="stake">Stake</th>
                        <th class="sortable" data-sort="result">Result</th>
                        <th class="sortable" data-sort="payout">Payout</th>
                        <th class="sortable" data-sort="actual">Actual FTD</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pick in picks %}
                    <tr class="pick-row {% if pick.result == 'Pending' %}pending-row{% elif pick.result == 'W' %}win-row{% elif pick.result == 'L' %}loss-row{% endif %}"
                        data-week="{{ pick.game.week }}"
                        data-user="{{ pick.user.username }}"
                        data-type="{{ pick.pick_type }}"
                        data-result="{{ pick.result }}"
                        data-game="{{ pick.game.away_team }} @ {{ pick.game.home_team }}"
                        data-player="{{ pick.player_name|lower }}"
                        data-search="{{ pick.player_name|lower }} {{ pick.user.username|lower }}"
                        data-week-num="{{ pick.game.week }}"
                        data-date-num="{{ pick.game.game_date.strftime('%Y%m%d') if pick.game.game_date else '0' }}"
                        data-odds-num="{{ pick.odds }}"
                        data-stake-num="{{ pick.stake }}"
                        data-payout-num="{{ pick.payout if pick.payout else 0 }}"
                        data-position="{{ pick.player_position if pick.player_position else 'ZZZ' }}">
                        <td><strong>{{ pick.game.week }}</strong></td>
                        <td><small>{{ pick.game.away_team }} @ {{ pick.game.home_team }}</small></td>
                        <td><small>{{ pick.game.game_date.strftime('%m/%d') if pick.game.game_date else '-' }}</small></td>
                        <td><strong>{{ pick.user.username }}</strong></td>
                        <td>{{ pick.player_name }}</td>
                        <td>
                            {% if pick.player_position %}
                            <span class="badge {% if pick.player_position == 'QB' %}bg-primary{% elif pick.player_position == 'RB' %}bg-success{% elif pick.player_position == 'WR' %}bg-warning text-dark{% elif pick.player_position == 'TE' %}bg-info text-dark{% else %}bg-danger{% endif %} badge-sm">
                                {{ pick.player_position }}
                            </span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-primary badge-sm">{{ pick.pick_type }}</span></td>
                        <td><small>{{ "%+d"|format(pick.odds) }}</small></td>
                        <td><small>{{ "%.1f"|format(pick.stake) }}u</small></td>
                        <td>
                            {% if pick.result == 'W' %}
                            <span class="badge bg-success badge-sm">W</span>
                            {% elif pick.result == 'L' %}
                            <span class="badge bg-danger badge-sm">L</span>
                            {% elif pick.result == 'Push' %}
                            <span class="badge bg-secondary badge-sm">P</span>
                            {% else %}
                            <span class="badge bg-warning text-dark badge-sm">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pick.payout %}
                            <small class="{% if pick.payout > 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>{{ "%+.1f"|format(pick.payout) }}u</strong>
                            </small>
                            {% else %}
                            <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ pick.game.actual_first_td_player if pick.game.actual_first_td_player else '-' }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('main.edit_pick', pick_id=pick.id) }}" 
                                   class="btn btn-outline-primary btn-xs" 
                                   title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form method="POST" action="{{ url_for('main.delete_pick', pick_id=pick.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Delete this pick?');">
                                    <button type="submit" class="btn btn-outline-danger btn-xs" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p class="mb-0">No picks found for {{ season }} season.</p>
        </div>
        {% endif %}
    </div>

    <!-- Standardization Modal -->
    <div class="modal fade" id="standardizeModal" tabindex="-1" aria-labelledby="standardizeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="standardizeModalLabel">
                        <i class="bi bi-magic"></i> Data Standardization Review
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="standardizeContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing picks...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="applyStandardization" style="display: none;">
                        <i class="bi bi-check-circle"></i> Apply Selected Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Filter functionality
        const searchInput = document.getElementById('searchInput');
        const weekFilter = document.getElementById('weekFilter');
        const userFilter = document.getElementById('userFilter');
        const typeFilter = document.getElementById('typeFilter');
        const resultFilter = document.getElementById('resultFilter');
        const gameFilter = document.getElementById('gameFilter');
        const rows = document.querySelectorAll('.pick-row');
        const visibleCount = document.getElementById('visibleCount');

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedWeek = weekFilter.value;
            const selectedUser = userFilter.value;
            const selectedType = typeFilter.value;
            const selectedResult = resultFilter.value;
            const selectedGame = gameFilter.value;
            
            let visible = 0;
            
            rows.forEach(row => {
                const matchesSearch = row.dataset.search.includes(searchTerm);
                const matchesWeek = !selectedWeek || row.dataset.week === selectedWeek;
                const matchesUser = !selectedUser || row.dataset.user === selectedUser;
                const matchesType = !selectedType || row.dataset.type === selectedType;
                const matchesResult = !selectedResult || row.dataset.result === selectedResult;
                const matchesGame = !selectedGame || row.dataset.game === selectedGame;
                
                if (matchesSearch && matchesWeek && matchesUser && matchesType && matchesResult && matchesGame) {
                    row.style.display = '';
                    visible++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            visibleCount.textContent = visible;
        }

        // Attach event listeners
        searchInput.addEventListener('input', applyFilters);
        weekFilter.addEventListener('change', applyFilters);
        userFilter.addEventListener('change', applyFilters);
        typeFilter.addEventListener('change', applyFilters);
        resultFilter.addEventListener('change', applyFilters);
        gameFilter.addEventListener('change', applyFilters);

        function clearFilters() {
            searchInput.value = '';
            weekFilter.value = '';
            userFilter.value = '';
            typeFilter.value = '';
            resultFilter.value = '';
            gameFilter.value = '';
            applyFilters();
        }

        function exportToCSV() {
            let csv = 'Week,Game,Date,User,Player,Position,Type,Odds,Stake,Result,Payout,Actual FTD\n';
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = row.querySelectorAll('td');
                    const rowData = [
                        cells[0].textContent.trim(),
                        cells[1].textContent.trim(),
                        cells[2].textContent.trim(),
                        cells[3].textContent.trim(),
                        cells[4].textContent.trim(),
                        cells[5].textContent.trim(),
                        cells[6].textContent.trim(),
                        cells[7].textContent.trim(),
                        cells[8].textContent.trim(),
                        cells[9].textContent.trim(),
                        cells[10].textContent.trim(),
                        cells[11].textContent.trim()
                    ];
                    csv += rowData.map(cell => `"${cell}"`).join(',') + '\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `picks_{{ season }}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Sorting functionality
        let currentSort = { column: null, direction: 'asc' };
        
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const sortKey = this.dataset.sort;
                
                // Toggle direction if same column, else default to ascending
                if (currentSort.column === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = sortKey;
                    currentSort.direction = 'asc';
                }
                
                // Update header classes
                document.querySelectorAll('th.sortable').forEach(h => {
                    h.classList.remove('asc', 'desc');
                });
                this.classList.add(currentSort.direction);
                
                // Sort the rows
                sortTable(sortKey, currentSort.direction);
            });
        });
        
        function sortTable(column, direction) {
            const tbody = document.querySelector('#picksTable tbody');
            const rowsArray = Array.from(rows);
            
            rowsArray.sort((a, b) => {
                let aVal, bVal;
                
                // Get values based on column
                switch(column) {
                    case 'week':
                        aVal = parseInt(a.dataset.weekNum);
                        bVal = parseInt(b.dataset.weekNum);
                        break;
                    case 'date':
                        aVal = parseInt(a.dataset.dateNum);
                        bVal = parseInt(b.dataset.dateNum);
                        break;
                    case 'game':
                        aVal = a.dataset.game;
                        bVal = b.dataset.game;
                        break;
                    case 'user':
                        aVal = a.dataset.user;
                        bVal = b.dataset.user;
                        break;
                    case 'player':
                        aVal = a.dataset.player;
                        bVal = b.dataset.player;
                        break;
                    case 'position':
                        aVal = a.dataset.position;
                        bVal = b.dataset.position;
                        break;
                    case 'type':
                        aVal = a.dataset.type;
                        bVal = b.dataset.type;
                        break;
                    case 'odds':
                        aVal = parseInt(a.dataset.oddsNum);
                        bVal = parseInt(b.dataset.oddsNum);
                        break;
                    case 'stake':
                        aVal = parseFloat(a.dataset.stakeNum);
                        bVal = parseFloat(b.dataset.stakeNum);
                        break;
                    case 'result':
                        aVal = a.dataset.result;
                        bVal = b.dataset.result;
                        break;
                    case 'payout':
                        aVal = parseFloat(a.dataset.payoutNum);
                        bVal = parseFloat(b.dataset.payoutNum);
                        break;
                    case 'actual':
                        aVal = a.querySelector('td:nth-child(12)').textContent.trim();
                        bVal = b.querySelector('td:nth-child(12)').textContent.trim();
                        break;
                    default:
                        return 0;
                }
                
                // Compare
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Re-append rows in sorted order
            rowsArray.forEach(row => tbody.appendChild(row));
        }

        // Standardization functionality
        let pendingChanges = [];

        function standardizeData() {
            const modal = new bootstrap.Modal(document.getElementById('standardizeModal'));
            modal.show();
            
            const content = document.getElementById('standardizeContent');
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing picks and matching with roster data...</p>
                </div>
            `;
            
            fetch('/api/standardize-picks/{{ season }}', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStandardizationSuggestions(data.suggestions, data.missing_atts || []);
                } else {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
                    </div>
                `;
            });
        }

        function displayStandardizationSuggestions(suggestions, missing_atts) {
            const content = document.getElementById('standardizeContent');
            const applyBtn = document.getElementById('applyStandardization');
            
            if (suggestions.length === 0 && missing_atts.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> All picks are already standardized and complete! No changes needed.
                    </div>
                `;
                applyBtn.style.display = 'none';
                return;
            }
            
            pendingChanges = [...suggestions];
            window.pendingATTS = [...missing_atts];
            applyBtn.style.display = 'block';
            
            let html = '';
            
            // Missing ATTS section
            if (missing_atts.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Found ${missing_atts.length} FTD pick(s) without corresponding ATTS picks.
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="selectAllATTS" checked onchange="toggleAllATTS(this)">
                        <label class="form-check-label" for="selectAllATTS">
                            <strong>Create All Missing ATTS Picks</strong>
                        </label>
                    </div>
                    <div class="table-responsive mb-4">
                        <table class="table table-sm table-hover table-bordered">
                            <thead class="table-warning">
                                <tr>
                                    <th style="width: 5%;"></th>
                                    <th>Week</th>
                                    <th>User</th>
                                    <th>Game</th>
                                    <th>Player</th>
                                    <th>Position</th>
                                    <th>Odds</th>
                                    <th>Stake</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                missing_atts.forEach((atts, idx) => {
                    html += `
                        <tr>
                            <td>
                                <input class="form-check-input atts-checkbox" type="checkbox" 
                                       data-index="${idx}" checked>
                            </td>
                            <td><strong>${atts.week}</strong></td>
                            <td>${atts.user}</td>
                            <td><small>${atts.game}</small></td>
                            <td>${atts.player_name}</td>
                            <td>${atts.player_position ? '<span class="badge bg-secondary">' + atts.player_position + '</span>' : '-'}</td>
                            <td><small>${atts.odds > 0 ? '+' : ''}${atts.odds}</small></td>
                            <td><small>${atts.stake}u</small></td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Data corrections section
            if (suggestions.length > 0) {
                html += `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Found ${suggestions.length} pick(s) with suggested data corrections.
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="selectAll" checked onchange="toggleAll(this)">
                        <label class="form-check-label" for="selectAll">
                            <strong>Select/Deselect All Corrections</strong>
                        </label>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;"></th>
                                    <th>Week</th>
                                    <th>User</th>
                                    <th>Game</th>
                                    <th>Field</th>
                                    <th>Current</th>
                                    <th>Suggested</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
            
            suggestions.forEach((suggestion, idx) => {
                const changes = suggestion.changes;
                const pickId = suggestion.pick_id;
                
                if (changes.player_name) {
                    html += `
                        <tr>
                            <td>
                                <input class="form-check-input change-checkbox" type="checkbox" 
                                       data-index="${idx}" data-field="player_name" checked>
                            </td>
                            <td><strong>${suggestion.week}</strong></td>
                            <td>${suggestion.user}</td>
                            <td><small>${suggestion.game}</small></td>
                            <td><span class="badge bg-primary">Player Name</span></td>
                            <td><code>${changes.player_name.current}</code></td>
                            <td><strong class="text-success">${changes.player_name.suggested}</strong></td>
                            <td>
                                <a href="/admin/picks/${pickId}/edit" class="btn btn-xs btn-outline-primary" title="Edit Pick">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            </td>
                        </tr>
                    `;
                }
                
                if (changes.player_position) {
                    html += `
                        <tr>
                            <td>
                                <input class="form-check-input change-checkbox" type="checkbox" 
                                       data-index="${idx}" data-field="player_position" checked>
                            </td>
                            <td><strong>${suggestion.week}</strong></td>
                            <td>${suggestion.user}</td>
                            <td><small>${suggestion.game}</small></td>
                            <td><span class="badge bg-secondary">Position</span></td>
                            <td><span class="text-muted">${changes.player_position.current || '(empty)'}</span></td>
                            <td><strong class="text-success">${changes.player_position.suggested}</strong></td>
                            <td>
                                <a href="/admin/picks/${pickId}/edit" class="btn btn-xs btn-outline-primary" title="Edit Pick">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            }
            
            content.innerHTML = html;
        }

        function toggleAll(checkbox) {
            document.querySelectorAll('.change-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }
        
        function toggleAllATTS(checkbox) {
            document.querySelectorAll('.atts-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        document.getElementById('applyStandardization').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.change-checkbox:checked');
            const checkedATTS = document.querySelectorAll('.atts-checkbox:checked');
            
            if (checkedBoxes.length === 0 && checkedATTS.length === 0) {
                alert('No changes selected to apply.');
                return;
            }
            
            const totalChanges = checkedBoxes.length + checkedATTS.length;
            if (!confirm(`Apply ${totalChanges} change(s)?`)) {
                return;
            }
            
            // Build list of changes to apply
            const changesToApply = [];
            const attsToCreate = [];
            
            // Process field changes
            checkedBoxes.forEach(checkbox => {
                const idx = parseInt(checkbox.dataset.index);
                const field = checkbox.dataset.field;
                const suggestion = pendingChanges[idx];
                
                // Find or create entry for this pick
                let pickChange = changesToApply.find(c => c.pick_id === suggestion.pick_id);
                if (!pickChange) {
                    pickChange = {
                        pick_id: suggestion.pick_id,
                        changes: {}
                    };
                    changesToApply.push(pickChange);
                }
                
                // Add this field change
                pickChange.changes[field] = suggestion.changes[field];
            });
            
            // Process ATTS creations
            checkedATTS.forEach(checkbox => {
                const idx = parseInt(checkbox.dataset.index);
                const attsData = window.pendingATTS[idx];
                attsToCreate.push(attsData);
            });
            
            // Apply changes via API
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Applying...';
            
            fetch('/api/apply-standardization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    changes: changesToApply,
                    create_atts: attsToCreate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message + ' Page will reload.');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Apply Selected Changes';
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check-circle"></i> Apply Selected Changes';
            });
        });
    </script>
</body>
</html>
