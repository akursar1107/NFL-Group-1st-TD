<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Review - Admin - NFL First TD League</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand mb-0 h1" href="/">üèà NFL First TD League</a>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-sm btn-outline-light">Standings</a>
                <a href="/best-bets" class="btn btn-sm btn-outline-light">üí∞ Best Bets</a>
                <a href="/analysis" class="btn btn-sm btn-outline-light">üìä Analysis</a>
                
                <!-- Admin Menu -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                        üîß Admin
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Grading</h6></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('gradeCurrentWeekForm').submit(); return false;">Grade Current Week</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Picks Management</h6></li>
                        <li><a class="dropdown-item" href="/admin/picks/new">‚ûï New Pick</a></li>
                        <li><a class="dropdown-item" href="/admin/all-picks">üìã All Picks</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Data Quality</h6></li>
                        <li><a class="dropdown-item active" href="/admin/match-review">üîç Match Review</a></li>
                    </ul>
                </div>
                
                <!-- User Menu -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                        üë§ {{ current_user.display_name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/change-password">üîë Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">üö™ Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Hidden form for grade current week -->
    <form id="gradeCurrentWeekForm" method="POST" action="/admin/grade-current-week" style="display: none;">
        <input type="hidden" name="season" value="2025">
    </form>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üîç Fuzzy Match Review</h2>
        <div>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">‚Üê Back to Home</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Needs Review</h5>
                    <h2 class="text-warning">{{ stats.needs_review }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Auto-Accepted</h5>
                    <h2 class="text-success">{{ stats.auto_accepted }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Manually Approved</h5>
                    <h2 class="text-info">{{ stats.approved }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Manually Rejected</h5>
                    <h2 class="text-danger">{{ stats.rejected }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Sort Options -->
    <div class="mb-3">
        <label class="me-2"><strong>Sort by:</strong></label>
        <div class="btn-group" role="group">
            <a href="?sort=date" class="btn btn-sm btn-{% if current_sort == 'date' or not current_sort %}primary{% else %}outline-primary{% endif %}">
                üìÖ Date
            </a>
            <a href="?sort=confidence" class="btn btn-sm btn-{% if current_sort == 'confidence' %}primary{% else %}outline-primary{% endif %}">
                üéØ Confidence
            </a>
            <a href="?sort=score" class="btn btn-sm btn-{% if current_sort == 'score' %}primary{% else %}outline-primary{% endif %}">
                üî¢ Score
            </a>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                Needs Review ({{ stats.needs_review }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                All Matches ({{ stats.total }})
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Pending Review Tab -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            {% if pending_matches %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Week/Game</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Pick Name</th>
                                <th>Scorer Name</th>
                                <th>Score</th>
                                <th>Confidence</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in pending_matches %}
                            <tr>
                                <td>
                                    <small class="text-muted">Week {{ match.pick.game.week }}</small><br>
                                    {{ match.pick.game.matchup }}
                                </td>
                                <td>{{ match.pick.user.username }}</td>
                                <td>
                                    <span class="badge bg-{% if match.pick.pick_type == 'FTD' %}primary{% else %}info{% endif %}">
                                        {{ match.pick.pick_type }}
                                    </span>
                                </td>
                                <td><strong>{{ match.pick_name }}</strong></td>
                                <td><strong>{{ match.scorer_name }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ "%.2f"|format(match.match_score) }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if match.confidence == 'high' %}success{% elif match.confidence == 'medium' %}warning{% else %}danger{% endif %}">
                                        {{ match.confidence }}
                                    </span>
                                </td>
                                <td><small>{{ match.match_reason }}</small></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <form method="POST" action="{{ url_for('main.review_match', match_id=match.id) }}" style="display: inline;">
                                            <input type="hidden" name="decision" value="approve">
                                            <button type="submit" class="btn btn-success" title="Approve match">
                                                ‚úì
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('main.review_match', match_id=match.id) }}" style="display: inline;">
                                            <input type="hidden" name="decision" value="reject">
                                            <button type="submit" class="btn btn-danger" title="Reject match">
                                                ‚úó
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions -->
                <div class="mt-3">
                    <form method="POST" action="{{ url_for('main.bulk_approve_matches') }}" style="display: inline;">
                        <button type="submit" class="btn btn-success" onclick="return confirm('Approve all pending matches?')">
                            ‚úì Approve All Pending
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('main.bulk_reject_matches') }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Reject all pending matches?')">
                            ‚úó Reject All Pending
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('main.bulk_revert_approved') }}" style="display: inline;">
                        <button type="submit" class="btn btn-secondary" onclick="return confirm('Revert all manually approved matches back to pending?')">
                            ‚Ü∂ Revert All Approved
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <strong>No matches need review!</strong> All matches have been auto-accepted or manually reviewed.
                </div>
            {% endif %}
        </div>

        <!-- All Matches Tab -->
        <div class="tab-pane fade" id="all" role="tabpanel">
            {% if all_matches %}
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Pick ‚Üí Scorer</th>
                                <th>Score</th>
                                <th>Confidence</th>
                                <th>Status</th>
                                <th>Pick Result</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in all_matches %}
                            <tr class="{% if match.needs_review %}table-warning{% elif match.manual_decision == 'approved' %}table-success{% elif match.manual_decision == 'rejected' %}table-danger{% endif %}">
                                <td>{{ match.pick.game.week }}</td>
                                <td>{{ match.pick.user.username }}</td>
                                <td>
                                    <span class="badge bg-{% if match.pick.pick_type == 'FTD' %}primary{% else %}info{% endif %}">
                                        {{ match.pick.pick_type }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ match.pick_name }} ‚Üí {{ match.scorer_name }}</small>
                                </td>
                                <td>{{ "%.2f"|format(match.match_score) }}</td>
                                <td>
                                    <span class="badge bg-{% if match.confidence == 'exact' %}primary{% elif match.confidence == 'high' %}success{% elif match.confidence == 'medium' %}warning{% else %}danger{% endif %}">
                                        {{ match.confidence }}
                                    </span>
                                </td>
                                <td>
                                    {% if match.auto_accepted %}
                                        <span class="badge bg-success">Auto</span>
                                    {% elif match.manual_decision %}
                                        <span class="badge bg-info">Manual ({{ match.manual_decision }})</span>
                                    {% else %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if match.pick.result == 'W' %}
                                        <span class="badge bg-success">Win</span>
                                    {% elif match.pick.result == 'L' %}
                                        <span class="badge bg-danger">Loss</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ match.pick.result }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if match.manual_decision %}
                                        <form method="POST" action="{{ url_for('main.revert_match', match_id=match.id) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-secondary" title="Revert to pending review">
                                                ‚Ü∂ Revert
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No match records found.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Confidence Distribution Chart -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>Match Confidence Distribution</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <h6>Exact</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-primary" style="width: {{ (stats.confidence_dist.exact / stats.total * 100) if stats.total > 0 else 0 }}%">
                            {{ stats.confidence_dist.exact }}
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <h6>High</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-success" style="width: {{ (stats.confidence_dist.high / stats.total * 100) if stats.total > 0 else 0 }}%">
                            {{ stats.confidence_dist.high }}
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <h6>Medium</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-warning" style="width: {{ (stats.confidence_dist.medium / stats.total * 100) if stats.total > 0 else 0 }}%">
                            {{ stats.confidence_dist.medium }}
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <h6>Low</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-danger" style="width: {{ (stats.confidence_dist.low / stats.total * 100) if stats.total > 0 else 0 }}%">
                            {{ stats.confidence_dist.low }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <p>
                    <strong>Auto-Accept Rate:</strong> {{ "%.1f"|format(stats.auto_accept_rate * 100) }}% 
                    ({{ stats.auto_accepted }} / {{ stats.total }})
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

